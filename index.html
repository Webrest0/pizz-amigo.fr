<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard — PIZZ’AMIGO</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #101418;
      --surface: #171c22;
      --surface-alt: #1f252d;
      --border: #27313d;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #2dd4bf;
      --accent-strong: #10b981;
      --danger: #f87171;
      --success: #22c55e;
      --shadow: 0 20px 45px rgba(0, 0, 0, 0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      line-height: 1.5;
    }

    header {
      padding: 1.5rem clamp(1rem, 4vw, 3rem);
      background: linear-gradient(135deg, rgba(16, 167, 112, 0.95), rgba(18, 112, 97, 0.8));
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header .title {
      font-size: clamp(1.4rem, 3vw, 2rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    header .subtitle {
      margin-top: 0.25rem;
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.78);
    }

    .controls {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .controls label {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.72);
    }

    .controls input {
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 999px;
      color: var(--text);
      padding: 0.65rem 1rem;
      min-width: min(320px, 100%);
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    .controls input:focus {
      outline: none;
      border-color: rgba(45, 212, 191, 0.75);
      box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.25);
    }

    .controls button {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      border: none;
      color: #0f172a;
      padding: 0.7rem 1.5rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 25px rgba(34, 197, 94, 0.25);
    }

    .controls button:disabled {
      opacity: 0.55;
      cursor: progress;
      box-shadow: none;
      transform: none;
    }

    main {
      flex: 1;
      padding: clamp(1rem, 3vw, 2.5rem);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .card {
      background: var(--surface);
      border-radius: 1.5rem;
      border: 1px solid var(--border);
      padding: clamp(1rem, 2vw, 1.75rem);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.18), transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card h2 {
      font-size: clamp(1.1rem, 2.2vw, 1.5rem);
      margin: 0 0 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h2 .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      display: inline-block;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.25);
    }

    .meta-info {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      font-size: 0.92rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .meta-info span {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 500;
    }

    .table-wrapper {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 1.25rem;
      overflow: hidden;
      background: var(--surface-alt);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      min-width: 700px;
    }

    thead {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      color: rgba(226, 232, 240, 0.7);
      backdrop-filter: blur(8px);
    }

    thead th {
      padding: 0.75rem 1rem;
      text-align: left;
      background: rgba(255, 255, 255, 0.03);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      white-space: nowrap;
    }

    tbody tr {
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(45, 212, 191, 0.05);
    }

    tbody td {
      padding: 0.9rem 1rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.12);
      font-size: 0.95rem;
      vertical-align: top;
    }

    tbody td strong {
      font-weight: 600;
    }

    tbody td .order-id {
      font-feature-settings: "tnum" 1;
      letter-spacing: 0.05em;
      color: var(--accent);
    }

    tbody td .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.04em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-nouveau {
      background: rgba(34, 197, 94, 0.18);
      color: #4ade80;
      border: 1px solid rgba(74, 222, 128, 0.35);
      box-shadow: inset 0 0 12px rgba(34, 197, 94, 0.2);
    }

    .badge-termine {
      background: rgba(148, 163, 184, 0.16);
      color: rgba(226, 232, 240, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .action-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
      border: none;
      border-radius: 0.85rem;
      padding: 0.55rem 1rem;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      letter-spacing: 0.04em;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

    .action-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      background: rgba(100, 116, 139, 0.3);
    }

    .action-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 20px rgba(248, 113, 113, 0.25);
    }

    .empty-state {
      text-align: center;
      padding: 2.5rem 1rem;
      color: var(--text-muted);
      font-size: 1rem;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 1.25rem;
    }

    .status-bar span {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .status-bar .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.18);
    }

    .status-message {
      margin-top: 1rem;
      padding: 0.85rem 1rem;
      border-radius: 0.85rem;
      border: 1px solid transparent;
      font-size: 0.9rem;
      display: none;
    }

    .status-message.visible {
      display: block;
    }

    .status-message.error {
      background: rgba(248, 113, 113, 0.08);
      border-color: rgba(248, 113, 113, 0.35);
      color: #fecaca;
    }

    .status-message.success {
      background: rgba(34, 197, 94, 0.08);
      border-color: rgba(34, 197, 94, 0.35);
      color: #bbf7d0;
    }

    footer {
      text-align: center;
      padding: 1.5rem;
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.6);
    }

    @media (max-width: 960px) {
      table {
        min-width: 100%;
      }

      .controls input {
        min-width: min(260px, 100%);
      }
    }

    @media (max-width: 780px) {
      header {
        padding: 1.25rem 1rem;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .controls button {
        justify-content: center;
        width: 100%;
      }

      .meta-info {
        flex-direction: column;
        gap: 0.75rem;
      }

      .table-wrapper {
        border-radius: 1rem;
      }

      table {
        font-size: 0.85rem;
      }

      thead th,
      tbody td {
        padding: 0.75rem;
        white-space: nowrap;
      }

      tbody td:last-child {
        min-width: 160px;
      }
    }

    @media (max-width: 520px) {
      body {
        font-size: 0.95rem;
      }

      header .title {
        font-size: 1.35rem;
      }

      .controls input {
        padding: 0.6rem 0.9rem;
        font-size: 0.95rem;
      }

      .controls button {
        padding: 0.65rem 1.15rem;
        font-size: 0.9rem;
      }

      .card {
        padding: 1rem;
        border-radius: 1rem;
      }

      thead th,
      tbody td {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">Dashboard — PIZZ’AMIGO</div>
    <p class="subtitle">Suivi en temps réel des commandes du camion Pizz’Amigo.</p>
    <div class="controls">
      <label for="adminKey">Clé admin (optionnelle)</label>
      <input id="adminKey" type="password" placeholder="Saisir la clé si nécessaire" autocomplete="off">
      <button type="button" id="refreshBtn">Actualiser</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2><span class="dot" aria-hidden="true"></span> Commandes en cours</h2>
      <div class="meta-info">
        <span>Dernier rafraîchissement : <strong id="lastSync">--:--:--</strong></span>
        <span>Intervalle auto : <strong>5 s</strong></span>
        <span>Total commandes : <strong id="orderCount">0</strong></span>
      </div>

      <div class="table-wrapper">
        <table aria-describedby="tableCaption">
          <caption id="tableCaption" style="display:none">Liste des commandes en temps réel</caption>
          <thead>
            <tr>
              <th scope="col">Heure</th>
              <th scope="col">ID</th>
              <th scope="col">Client</th>
              <th scope="col">Tél.</th>
              <th scope="col">Horaire</th>
              <th scope="col">Pizzas</th>
              <th scope="col">Total</th>
              <th scope="col">Statut</th>
              <th scope="col">Action</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>

      <div id="emptyState" class="empty-state" role="status" aria-live="polite">Aucune commande pour le moment.</div>
      <div id="statusMessage" class="status-message" role="alert"></div>

      <div class="status-bar">
        <span><span class="dot" aria-hidden="true"></span> Rafraîchissement auto actif</span>
        <span>Prochaine mise à jour dans <strong id="countdown">5</strong>&nbsp;s</span>
      </div>
    </section>
  </main>

  <footer>© Pizz’Amigo — Dashboard commandes</footer>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw_cAhR_LZgNRPzyABxZIWgqaYf-mBTPoisV8QgFgYUE-lVgI5pY-9_RFk_Z0w28itu/exec";
    const REFRESH_INTERVAL = 5000;

    const els = {
      adminKey: document.getElementById('adminKey'),
      refreshBtn: document.getElementById('refreshBtn'),
      lastSync: document.getElementById('lastSync'),
      orderCount: document.getElementById('orderCount'),
      countdown: document.getElementById('countdown'),
      ordersBody: document.getElementById('ordersBody'),
      emptyState: document.getElementById('emptyState'),
      statusMessage: document.getElementById('statusMessage')
    };

    let knownOrders = new Map();
    let hasFetchedOnce = false;
    let countdownTimer = null;
    let autoInterval = null;

    const audioContext = typeof window !== 'undefined' && (window.AudioContext || window.webkitAudioContext)
      ? new (window.AudioContext || window.webkitAudioContext)()
      : null;

    function playBeep() {
      if (!audioContext) return;
      if (audioContext.state === 'suspended') {
        audioContext.resume().catch(() => {});
      }
      const duration = 0.18;
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.type = 'square';
      oscillator.frequency.value = 1040;
      gainNode.gain.value = 0.08;
      oscillator.connect(gainNode).connect(audioContext.destination);
      oscillator.start();
      oscillator.stop(audioContext.currentTime + duration);
    }

    function setStatus(message, type = 'info') {
      if (!message) {
        els.statusMessage.className = 'status-message';
        els.statusMessage.textContent = '';
        els.statusMessage.style.display = 'none';
        return;
      }
      els.statusMessage.textContent = message;
      els.statusMessage.className = `status-message visible ${type === 'error' ? 'error' : 'success'}`;
      els.statusMessage.style.display = 'block';
    }

    function formatCurrency(value) {
      if (value === undefined || value === null || value === '') return '—';
      const number = Number(value);
      if (Number.isNaN(number)) return value;
      return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(number);
    }

    function formatList(items) {
      if (!items) return '—';
      if (Array.isArray(items)) return items.join(', ');
      return String(items);
    }

    function createBadge(status = '') {
      const normalized = status.toString().toLowerCase();
      const span = document.createElement('span');
      span.className = `badge ${normalized === 'nouveau' ? 'badge-nouveau' : 'badge-termine'}`;
      span.textContent = normalized || '—';
      return span;
    }

    function buildOrderRow(order) {
      const tr = document.createElement('tr');

      const fields = [
        order.heure || order.time || '—',
        order.id || order.ID || '—',
        order.client || order.name || '—',
        order.telephone || order.tel || order.phone || '—',
        order.horaire || order.creneau || '—'
      ];

      fields.forEach((value, index) => {
        const td = document.createElement('td');
        if (index === 1) {
          const strong = document.createElement('strong');
          strong.className = 'order-id';
          strong.textContent = value;
          td.appendChild(strong);
        } else {
          td.textContent = value || '—';
        }
        tr.appendChild(td);
      });

      const pizzasTd = document.createElement('td');
      pizzasTd.textContent = formatList(order.pizzas || order.items);
      tr.appendChild(pizzasTd);

      const totalTd = document.createElement('td');
      totalTd.textContent = formatCurrency(order.total || order.montant);
      tr.appendChild(totalTd);

      const statusTd = document.createElement('td');
      statusTd.appendChild(createBadge(order.statut || order.status));
      tr.appendChild(statusTd);

      const actionTd = document.createElement('td');
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'action-btn';
      button.textContent = 'Marquer comme terminé';
      const orderId = order.id || order.ID;
      if (!orderId || String(order.statut || order.status).toLowerCase() === 'terminé') {
        button.disabled = true;
      }
      button.addEventListener('click', () => markAsComplete(orderId, button));
      actionTd.appendChild(button);
      tr.appendChild(actionTd);

      return tr;
    }

    function updateTable(orders) {
      els.ordersBody.innerHTML = '';
      if (!Array.isArray(orders) || orders.length === 0) {
        els.emptyState.style.display = 'block';
        els.orderCount.textContent = '0';
        return;
      }

      els.emptyState.style.display = 'none';
      els.orderCount.textContent = orders.length.toString();

      const fragment = document.createDocumentFragment();
      orders.forEach(order => {
        const row = buildOrderRow(order);
        fragment.appendChild(row);
      });
      els.ordersBody.appendChild(fragment);
    }

    function detectNewOrders(orders) {
      const currentIds = new Map();
      let hasNew = false;
      orders.forEach(order => {
        const id = order.id || order.ID;
        if (id) currentIds.set(String(id), order);
        const status = (order.statut || order.status || '').toString().toLowerCase();
        if (id && !knownOrders.has(String(id)) && status !== 'terminé') {
          hasNew = true;
        }
      });
      knownOrders = currentIds;
      if (hasNew && hasFetchedOnce) {
        playBeep();
      }
    }

    function updateSyncTime() {
      const now = new Date();
      els.lastSync.textContent = now.toLocaleTimeString('fr-FR');
    }

    function startCountdown() {
      let remaining = REFRESH_INTERVAL / 1000;
      els.countdown.textContent = remaining.toString();
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          els.countdown.textContent = '0';
          clearInterval(countdownTimer);
          return;
        }
        els.countdown.textContent = remaining.toString();
      }, 1000);
    }

    async function markAsComplete(orderId, button) {
      if (!orderId) return;
      const adminKey = els.adminKey.value.trim();
      if (!adminKey) {
        setStatus('Veuillez saisir la clé admin pour terminer une commande.', 'error');
        return;
      }
      button.disabled = true;
      button.textContent = 'Mise à jour…';
      try {
        const url = new URL(API_URL);
        url.searchParams.set('action', 'complete');
        const response = await fetch(url.toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: orderId, adminKey })
        });
        if (!response.ok) {
          throw new Error(`Erreur ${response.status}`);
        }
        setStatus('Commande marquée comme terminée.', 'success');
        await fetchOrders();
      } catch (error) {
        console.error(error);
        setStatus(`Impossible de terminer la commande : ${error.message}`, 'error');
        button.disabled = false;
        button.textContent = 'Marquer comme terminé';
      }
    }

    async function fetchOrders() {
      const adminKey = els.adminKey.value.trim();
      const url = new URL(API_URL);
      if (adminKey) {
        url.searchParams.set('adminKey', adminKey);
      }
      try {
        els.refreshBtn.disabled = true;
        setStatus('');
        const response = await fetch(url.toString(), { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Erreur ${response.status}`);
        }
        const data = await response.json();
        const orders = Array.isArray(data?.orders) ? data.orders : Array.isArray(data) ? data : [];
        detectNewOrders(orders);
        updateTable(orders);
        updateSyncTime();
        startCountdown();
        hasFetchedOnce = true;
      } catch (error) {
        console.error(error);
        setStatus(`Impossible de récupérer les commandes : ${error.message}`, 'error');
      } finally {
        els.refreshBtn.disabled = false;
      }
    }

    function startAutoRefresh() {
      if (autoInterval) clearInterval(autoInterval);
      autoInterval = setInterval(() => {
        fetchOrders();
      }, REFRESH_INTERVAL);
      startCountdown();
    }

    function init() {
      els.refreshBtn.addEventListener('click', () => {
        if (audioContext && audioContext.state === 'suspended') {
          audioContext.resume().catch(() => {});
        }
        fetchOrders();
      });

      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          startCountdown();
        }
      });

      fetchOrders();
      startAutoRefresh();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
