<script>
/* ==== Anti page blanche ==== */
function showErr(msg){const b=document.getElementById('err');b.style.display='block';document.getElementById('err-msg').textContent=msg;}
addEventListener('error',e=>showErr(e.message+'\n'+(e.error&&e.error.stack||'')));
addEventListener('unhandledrejection',e=>showErr('Promise rejet√©e: '+(e.reason&&e.reason.message||e.reason)));

/* ==== CONFIG (MODIFIE ICI si besoin) ==== */
const API_URL = "https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec"; // <‚Äî MODIFIE ICI
const SUPPL_PRICE = 1.00;
const SUPPL_CHOICES = ["viande","poisson","≈ìuf","fromage"];

/* ==== CARTE COMPL√àTE ==== */
const MENU = [
  {n:"Margharita", p:7.50, d:"tomate, emmental"},
  {n:"Chasseur", p:8.50, d:"tomate, emmental, champignons"},
  {n:"Sicilienne", p:8.50, d:"tomate, emmental, anchois"},
  {n:"Napolitaine", p:9.00, d:"tomate, emmental, jambon"},
  {n:"Paysanne", p:9.50, d:"tomate, emmental, jambon, ≈ìuf"},
  {n:"Capri", p:9.50, d:"tomate, emmental, jambon, champignons"},
  {n:"Mozzarella", p:9.50, d:"tomate, emmental, mozzarella"},
  {n:"Quatre saisons", p:9.50, d:"tomate, emmental, oignons, champignons, poivrons, mozzarella"},
  {n:"V√©nitienne", p:9.50, d:"tomate, emmental, roquefort, oignons, cr√®me"},
  {n:"Oslo", p:10.00, d:"tomate, emmental, thon, champignons, cr√®me"},
  {n:"Orientale", p:10.00, d:"tomate, emmental, merguez, poivrons"},
  {n:"Bolognaise", p:10.00, d:"tomate, emmental, viande hach√©e, cr√®me, mozzarella"},
  {n:"Fermi√®re", p:10.00, d:"tomate, emmental, ≈ìuf, lardons, champignons"},
  {n:"Miel", p:10.50, d:"cr√®me, emmental, ch√®vre frais, miel"},
  {n:"Foresti√®re", p:10.50, d:"tomate, emmental, poulet, champignons, cr√®me"},
  {n:"Lyonnaise", p:11.00, d:"tomate, emmental, saint-marcellin, poulet, cr√®me"},
  {n:"Quatre fromages", p:11.00, d:"tomate, emmental, ch√®vre, roquefort, mozzarella"},
  {n:"Paradoxe", p:11.00, d:"tomate, emmental, ≈ìuf, jambon, chorizo, mozzarella"},
  {n:"Bois√©e", p:11.00, d:"cr√®me, emmental, pomme de terre, poulet, poivrons, sauce gruy√®re"},
  {n:"Savoyarde", p:11.00, d:"emmental, lardons, reblochon, pomme de terre, cr√®me"},
  {n:"Carnivore", p:11.50, d:"tomate, emmental, viande hach√©e, merguez, ≈ìuf, mozzarella"},
  {n:"Norv√©gienne", p:11.50, d:"emmental, saumon fum√©, mozzarella, cr√®me"},
  {n:"Burger", p:12.00, d:"tomate, emmental, viande hach√©e, oignons, cheddar, tomate cerise, sauce burger"},
  {n:"Canette 33cl (choisie sur place)", p:1.50, d:"boisson ‚Äî saveur choisie sur place", drink:true},
  {n:"Bouteille 50cl (choisie sur place)", p:3.00, d:"boisson ‚Äî saveur choisie sur place", drink:true},
];

/* ==== PANIER ==== */
const cart={
  items:[], // {name,qty,price,suppl:{type?,price}}
  get total(){return this.items.reduce((s,i)=>s+(i.price+(i.suppl?.price||0))*i.qty,0)},
  add(prod,withSuppl=false,supplType=null){
    const key=prod.n+'|'+(withSuppl?supplType:''); const it=this.items.find(i=>i._k===key);
    if(it) it.qty++; else this.items.push({_k:key,name:prod.n,qty:1,price:prod.p,suppl:withSuppl?{type:supplType,price:SUPPL_PRICE}:null});
    renderCartBar();
  },
  remove(idx){this.items.splice(idx,1);renderCartBar();},
  clear(){this.items.length=0;renderCartBar();}
};

const euro=v=>v.toFixed(2).replace('.',',');

/* ==== RENDU CARTE ==== */
function renderMenu(){
  const root=document.getElementById('menu'); root.innerHTML='';
  MENU.forEach(p=>{
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`
      <div class="row">
        <div>
          <div class="item-name">${p.n}</div>
          <div class="item-desc">${p.d||''}</div>
        </div>
        <div class="row" style="gap:10px">
          <div class="price">${euro(p.p)} ‚Ç¨</div>
          <button class="btn add">Ajouter</button>
        </div>
      </div>`;
    el.querySelector('.add').onclick=()=>{
      if(p.drink){ cart.add(p,false,null); return; }       // jamais de suppl√©ment pour boisson
      const yes=confirm("Suppl√©ment +1 ‚Ç¨ ?\nOK = Oui ¬∑ Annuler = Non");
      if(!yes){ cart.add(p,false,null); return; }
      const t=prompt("Choisis le type de suppl√©ment :\nviande / poisson / ≈ìuf / fromage","viande");
      const choice=(t||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
      const valid=SUPPL_CHOICES.find(c=>c===choice)||"viande";
      cart.add(p,true,valid);
    };
    root.appendChild(el);
  });
}

/* ==== BARRE PANIER ==== */
function renderCartBar(){
  const bar=document.getElementById('cart-bar');
  document.getElementById('cart-total').textContent=euro(cart.total);
  bar.classList.toggle('hidden', cart.items.length===0);
}

/* ==== MODAL PANIER ==== */
function openModal(){
  const m=document.getElementById('checkout'); const list=document.getElementById('ck-items');
  list.innerHTML='';
  cart.items.forEach((it,idx)=>{
    const sup=it.suppl?` (+${euro(it.suppl.price)} ‚Ç¨ ‚Ä¢ ${it.suppl.type})`:'';
    const line=document.createElement('div'); line.className='row'; line.style.cssText='margin:10px 0;border-bottom:1px solid rgba(255,255,255,.08)';
    line.innerHTML=`
      <div><b>${it.name}</b>${sup}</div>
      <div class="row" style="gap:6px">
        <button class="btn" aria-label="moins">‚àí</button>
        <div style="min-width:24px;text-align:center">${it.qty}</div>
        <button class="btn" aria-label="plus">+</button>
        <button class="btn red" aria-label="sup">üóëÔ∏è</button>
        <div class="price">${euro((it.price+(it.suppl?.price||0))*it.qty)} ‚Ç¨</div>
      </div>`;
    line.querySelector('[aria-label="moins"]').onclick=()=>{ if(it.qty>1) it.qty--; else cart.remove(idx); openModal(); renderCartBar(); };
    line.querySelector('[aria-label="plus"]').onclick =()=>{ it.qty++; openModal(); renderCartBar(); };
    line.querySelector('[aria-label="sup"]').onclick  =()=>{ cart.remove(idx); openModal(); };
    list.appendChild(line);
  });
  document.querySelectorAll('.pill').forEach(p=>{
    p.onclick=()=>{ document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active'); document.getElementById('ck-slot').value=p.textContent.trim(); };
  });
  m.showModal();
}
function closeModal(){ document.getElementById('checkout').close(); }

/* ==== ENVOI API (text/plain, payload attendu par l‚ÄôApps Script) ==== */
async function sendOrder(){
  try{
    const name=document.getElementById('ck-name').value.trim();
    const phone=document.getElementById('ck-phone').value.trim();
    const slot=document.getElementById('ck-slot').value.trim();
    const note=document.getElementById('ck-note').value.trim();
    if(!name||!phone||!slot||cart.items.length===0){ alert("Merci de compl√©ter nom, t√©l√©phone, horaire et panier."); return; }

    // L‚ÄôAPI attend "basket" (pas "items") + j‚Äôenvoie action=order pour compat.
    const payload={
      action:"order", order:1,
      name, phone, slot, note,
      basket: cart.items.map(i=>({name:i.name, qty:i.qty, price:i.price, supplType:i.suppl?.type||null, supplPrice:i.suppl?.price||0})),
      total: Number(cart.total.toFixed(2)),
      source: "site"
    };

    const res=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(payload)});
    const txt=await res.text(); let data; try{data=JSON.parse(txt);}catch{data={ok:false,raw:txt};}
    if(!res.ok||!data.ok) throw new Error(data.error||('HTTP '+res.status+' ‚Äî '+txt));

    cart.clear(); closeModal(); alert("Commande enregistr√©e. Merci !");
  }catch(err){ showErr(String(err)); alert("Impossible d'envoyer la commande. Merci de r√©essayer."); }
}

/* ==== HOOKS ==== */
document.getElementById('btn-view').onclick=openModal;
document.getElementById('btn-checkout').onclick=openModal;
document.getElementById('btn-close').onclick=(e)=>{e.preventDefault();closeModal();};
document.getElementById('btn-send').onclick=(e)=>{e.preventDefault();sendOrder();};

renderMenu(); renderCartBar();
</script>
