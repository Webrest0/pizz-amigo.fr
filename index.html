<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PIZZ‚ÄôAMIGO ‚Äî Montmerle-sur-Sa√¥ne</title>
  <style>
    :root{--bg:#0b0f14;--panel:#121a2b;--line:#243156;--green:#19c37d;--muted:#b9c2d6;--accent:#ffb54c;--danger:#c13d3d}
    html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:16px auto;padding:0 12px}
    header.hero{border-radius:18px;overflow:hidden;background:radial-gradient(ellipse at center, #3b2a1a 0%, #1a1f2b 70%);position:relative}
    header.hero img{display:block;width:100%;height:220px;object-fit:cover;opacity:.55;filter:contrast(1.05) saturate(1.05)}
    .hero-txt{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;padding:16px;background:linear-gradient(180deg,rgba(0,0,0,0) 40%,rgba(0,0,0,.7))}
    h1{margin:0 0 6px 0;font-size:28px}
    .badge{display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.25);backdrop-filter:blur(4px);width:max-content;margin:10px}
    .dot{width:8px;height:8px;border-radius:50%;background:#36d36a;display:inline-block}
    h2{margin:18px 0 8px}
    .note{background:#2a1b1b;border:1px solid #5d2f2f;color:#ffd1d1;padding:10px 12px;border-radius:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px 12px;margin:10px 0}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .price{color:#39d07e;font-weight:700;white-space:nowrap}
    .btn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--green);border-color:transparent;color:#000}
    #cart-bar{position:sticky;bottom:0;left:0;right:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);
      padding:12px;display:flex;gap:12px;justify-content:center}
    #cart-bar.hidden{display:none}
    dialog{border:1px solid var(--line);background:var(--panel);color:#fff;border-radius:16px;max-width:720px;width:calc(100% - 24px)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .slots{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pill{border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center;cursor:pointer}
    .pill.active{outline:2px solid var(--accent);background:rgba(255,181,76,.08)}
    /* PANNEAU ERREUR (pour ne plus avoir page blanche) */
    #err{position:fixed;right:8px;bottom:8px;max-width:92vw;background:#2a1b1b;border:1px solid #5d2f2f;border-radius:10px;padding:10px 12px;display:none}
    #err pre{white-space:pre-wrap;margin:6px 0 0 0;color:#ffd1d1}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="badge"><span class="dot"></span><b>PIZZ‚ÄôAMIGO</b></div>

    <header class="hero">
      <img src="./images/oven.jpg" alt="Four √† pizza" />
      <div class="hero-txt">
        <h1>PIZZ‚ÄôAMIGO ‚Äî Montmerle-sur-Sa√¥ne</h1>
        <div>Le go√ªt authentique de l‚ÄôItalie pr√®s de chez vous.</div>
      </div>
    </header>

    <div class="note" style="margin:14px 0">
      <b>Ferm√© pour le moment</b> ‚Äî retrouvez-nous ce week-end !
    </div>

    <h2>Notre carte</h2>
    <p>Boissons : r√©glez en ligne, <b>saveur choisie sur place</b>. Suppl√©ment (viande / poisson / ≈ìuf / fromage) : +1 ‚Ç¨ par ajout.</p>

    <div id="menu"></div>

    <!-- Barre panier -->
    <div id="cart-bar" class="hidden">
      <span>Panier ‚Ä¢ <b><span id="cart-total">0,00</span> ‚Ç¨</b></span>
      <button class="btn" id="btn-view">Voir panier</button>
      <button class="btn primary" id="btn-checkout">Passer commande</button>
    </div>

    <!-- Modal checkout -->
    <dialog id="checkout">
      <form method="dialog" style="padding:16px">
        <h2>Finaliser la commande</h2>
        <div id="ck-items" class="card" style="min-height:40px"></div>
        <div class="grid2">
          <label>Nom*<br><input id="ck-name" placeholder="Votre nom" style="width:100%"></label>
          <label>T√©l√©phone*<br><input id="ck-phone" placeholder="06‚Ä¶" style="width:100%"></label>
          <label>Heure de retrait*<br><input id="ck-slot" value="19:00" style="width:100%"></label>
          <label>Commentaire (optionnel)<br><textarea id="ck-note" placeholder="Sans olives, etc." style="width:100%"></textarea></label>
        </div>
        <div class="slots" style="margin:12px 0">
          <div class="pill">18:00</div><div class="pill">18:30</div><div class="pill">19:00</div><div class="pill">19:30</div>
          <div class="pill">20:00</div><div class="pill">20:30</div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn" id="btn-close">Fermer</button>
          <button class="btn primary" id="btn-send">Envoyer la commande</button>
        </div>
      </form>
    </dialog>

    <div id="err"><b>Erreur JavaScript</b><pre id="err-msg"></pre></div>
  </div>

  <script>
  // ========= SECURIT√â : afficher toute erreur au lieu d'une page blanche
  function showErr(msg){ const b=document.getElementById('err'); b.style.display='block'; document.getElementById('err-msg').textContent=msg; }
  window.addEventListener('error', e=>showErr(e.message+'\\n'+(e.error&&e.error.stack||'')));
  window.addEventListener('unhandledrejection', e=>showErr('Promise rejet√©e: '+(e.reason&&e.reason.message||e.reason)));

  // ========= CONFIG
  const API_URL = "https://script.google.com/macros/s/AKfycbw6YCxMsuQWvbseL44mpzaTFsaFq2PtzUhyea6M3yEy5dWjUMg7an97Lld9vo4aFIg7/exec";

  // ========= CARTE (r√©sum√© ‚Äî garde ta version longue si tu veux)
  const MENU = [
    {name:"Margharita", price:7.50, desc:"tomate, emmental"},
    {name:"Chasseur", price:8.50, desc:"tomate, emmental, champignons"},
    {name:"Sicilienne", price:8.50, desc:"tomate, emmental, anchois"},
    {name:"Napolitaine", price:9.00, desc:"tomate, emmental, jambon"},
    {name:"Canette 33cl (choisie sur place)", price:1.50, desc:"boisson ‚Äî saveur choisie sur place", noSuppl:true},
    {name:"Bouteille 50cl (choisie sur place)", price:3.00, desc:"boisson ‚Äî saveur choisie sur place", noSuppl:true},
  ];
  const SUPPL_PRICE = 1.00;

  // ========= PANIER
  const cart = {
    items: [], // {name,qty,price,suppl}
    get total(){return this.items.reduce((s,i)=>s + (i.price + (i.suppl||0))*i.qty, 0)},
    add(p, withSuppl=false){
      const it = this.items.find(i=>i.name===p.name && !!i.suppl===!!withSuppl);
      if(it) it.qty++; else this.items.push({name:p.name, qty:1, price:p.price, suppl: withSuppl?SUPPL_PRICE:0});
      renderCartBar();
    },
    remove(idx){ this.items.splice(idx,1); renderCartBar(); },
    clear(){ this.items.length=0; renderCartBar(); }
  };

  function euro(v){ return v.toFixed(2).replace('.', ','); }

  // ========= RENDUS
  function renderMenu(){
    const root = document.getElementById('menu'); root.innerHTML='';
    MENU.forEach(p=>{
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="row">
          <div><div style="font-weight:700;font-size:20px">${p.name}</div>
            <div style="opacity:.85">${p.desc||''}</div></div>
          <div class="row" style="gap:10px">
            <div class="price">${euro(p.price)} ‚Ç¨</div>
            <button class="btn add">Ajouter</button>
          </div>
        </div>`;
      card.querySelector('.add').addEventListener('click', ()=>{
        if(!p.noSuppl){
          const yes = confirm("Suppl√©ment +1 ‚Ç¨ ?\\nOK = Oui ¬∑ Annuler = Non");
          cart.add(p, !!yes);
        }else{
          cart.add(p,false);
        }
      });
      root.appendChild(card);
    });
  }

  function renderCartBar(){
    const bar = document.getElementById('cart-bar');
    document.getElementById('cart-total').textContent = euro(cart.total);
    bar.classList.toggle('hidden', cart.items.length===0);
  }

  function openModal(){
    const m = document.getElementById('checkout'); const list = document.getElementById('ck-items');
    list.innerHTML = '';
    cart.items.forEach((it,idx)=>{
      const line = document.createElement('div'); line.className='row';
      line.style.margin='10px 0'; line.style.borderBottom='1px solid rgba(255,255,255,.08)';
      const sup = it.suppl?` (+${euro(it.suppl)} ‚Ç¨ suppl.)`:'';
      line.innerHTML = `
        <div><b>${it.name}</b> ‚Äî <span style="opacity:.8">${it.qty} √ó</span> ${sup}</div>
        <div class="row" style="gap:6px">
          <button class="btn b-" aria-label="moins">‚àí</button>
          <div style="min-width:24px;text-align:center">${it.qty}</div>
          <button class="btn b+" aria-label="plus">+</button>
          <button class="btn" aria-label="supprimer">üóëÔ∏è</button>
          <div class="price">${euro((it.price+(it.suppl||0))*it.qty)} ‚Ç¨</div>
        </div>`;
      line.querySelector('.b-').onclick = ()=>{ if(it.qty>1){ it.qty--; } else { cart.remove(idx); } openModal(); renderCartBar(); };
      line.querySelector('.b+').onclick = ()=>{ it.qty++; openModal(); renderCartBar(); };
      line.querySelector('[aria-label="supprimer"]').onclick = ()=>{ cart.remove(idx); openModal(); };
      list.appendChild(line);
    });
    // activer s√©lection cr√©neau
    document.querySelectorAll('.pill').forEach(p=>{
      p.onclick = ()=>{ document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); document.getElementById('ck-slot').value=p.textContent.trim(); };
    });
    m.showModal();
  }

  function closeModal(){ document.getElementById('checkout').close(); }

  // ========= ENVOI API (text/plain)
  async function sendOrder(){
    try{
      const name = document.getElementById('ck-name').value.trim();
      const phone = document.getElementById('ck-phone').value.trim();
      const slot = document.getElementById('ck-slot').value.trim();
      const note = document.getElementById('ck-note').value.trim();
      if(!name || !phone || !slot || cart.items.length===0){ alert("Merci de compl√©ter nom, t√©l√©phone, horaire et panier."); return; }

      const payload = {
        name, phone, slot, note,
        items: cart.items.map(i=>({name:i.name, qty:i.qty, price:i.price, suppl:i.suppl||0})),
        total: Number(cart.total.toFixed(2)),
        source: "site"
      };

      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const txt = await res.text();
      let data; try{ data = JSON.parse(txt); }catch{ data={ok:false, raw:txt}; }

      if(!res.ok || !data.ok){
        console.error('API fail', res.status, data);
        alert("Impossible d'envoyer la commande. Merci de r√©essayer.");
        return;
      }

      cart.clear();
      closeModal();
      alert("Commande enregistr√©e. Merci !");
    }catch(err){
      showErr(String(err));
      alert("Impossible d'envoyer la commande. Merci de r√©essayer.");
    }
  }

  // ========= HOOKS
  document.getElementById('btn-view').onclick = openModal;
  document.getElementById('btn-checkout').onclick = openModal;
  document.getElementById('btn-close').onclick = (e)=>{ e.preventDefault(); closeModal(); };
  document.getElementById('btn-send').onclick = (e)=>{ e.preventDefault(); sendOrder(); };

  renderMenu(); renderCartBar();
  </script>
</body>
</html>
