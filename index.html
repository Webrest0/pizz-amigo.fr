<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard — PIZZ’AMIGO</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--line:#283149;--muted:#b8c2d6;--green:#1fcf7c;--red:#e55252}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  h1{margin:6px 0 10px}
  .bar{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px}
  .bar .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input{background:#0e1420;color:#fff;border:1px solid var(--line);border-radius:8px;padding:8px 10px;min-width:260px}
  .btn{border:1px solid #666;background:transparent;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
  .btn.primary{background:var(--green);color:#001b10;border-color:transparent}
  .btn.red{background:var(--red);border-color:transparent}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  th{background:#0f1521;position:sticky;top:0;z-index:2}
  tr:nth-child(even){background:#121a27}
  .actions .btn{padding:6px 8px;margin:2px;font-size:13px}

  /* Mobile */
  @media(max-width:760px){
    table, thead, tbody, th, td, tr{display:block}
    thead{display:none}
    tbody tr{margin:10px 0;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    td{border:none;border-bottom:1px solid var(--line);position:relative;padding-left:45%}
    td:last-child{border-bottom:none}
    td::before{position:absolute;left:8px;top:10px;width:40%;white-space:nowrap;color:#9ec7ff;font-weight:700}
    td:nth-of-type(1)::before{content:"Heure";}
    td:nth-of-type(2)::before{content:"ID";}
    td:nth-of-type(3)::before{content:"Client";}
    td:nth-of-type(4)::before{content:"Téléphone";}
    td:nth-of-type(5)::before{content:"Horaire";}
    td:nth-of-type(6)::before{content:"Pizzas";}
    td:nth-of-type(7)::before{content:"Total";}
    td:nth-of-type(8)::before{content:"Statut";}
    td:nth-of-type(9)::before{content:"Action";}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard — PIZZ’AMIGO</h1>

  <div class="bar">
    <div class="row">
      <label class="muted">API :</label>
      <input id="api" />
      <label class="muted">Clé admin (facultatif) :</label>
      <input id="adminkey" placeholder="ex: PIZZAMIGO-ADMIN-123"/>
      <button class="btn" onclick="saveCfg()">Enregistrer</button>
      <button class="btn" onclick="fetchAndMerge()">Actualiser</button>
      <button class="btn primary" onclick="demoOrder()">Démo</button>
    </div>
    <div id="status" class="muted" style="margin-top:6px"></div>
  </div>

  <table id="orders">
    <thead>
      <tr><th>Heure</th><th>ID</th><th>Client</th><th>Téléphone</th><th>Horaire</th><th>Pizzas</th><th>Total</th><th>Statut</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- son cloche court -->
<audio id="ding" preload="auto">
  <source src="https://actions.google.com/sounds/v1/doors/doorbell.ogg" type="audio/ogg">
</audio>

<script>
/* ===== CONFIG ===== */
const LSKEY="pizzapi", LSADM="pizzadm";
const DEFAULT_API="https://script.google.com/macros/s/AKfycbyePXcqPFPs0uhNOcVM5J5Nq3LCgsrB9UKVOmit1HVoTBzCdZRDCxEntrydbXSyQMXu/exec";

api.value = localStorage.getItem(LSKEY) || DEFAULT_API;
adminkey.value = localStorage.getItem(LSADM) || "";

/* ===== ÉTAT =====
   rows = Map(id -> {tr, data})
   On MERGE: on ajoute/maj les ids reçus, on NE SUPPRIME RIEN. */
const rows = new Map();

function saveCfg(){
  localStorage.setItem(LSKEY, api.value.trim());
  localStorage.setItem(LSADM, adminkey.value.trim());
  alert("Config enregistrée.");
}

function pizzasText(o){
  const items = (o.basket || o.items || []);
  return items.map(i => ((i.name||i.n)||'') + " x" + (i.qty||1)).join(", ");
}
function euro(v){ return (Number(v)||0).toFixed(2) + " €"; }

function buildRow(o){
  const tr = document.createElement("tr");
  tr.dataset.id = o.id;

  const tdWhen = document.createElement("td");
  const tdId   = document.createElement("td");
  const tdName = document.createElement("td");
  const tdPhone= document.createElement("td");
  const tdSlot = document.createElement("td");
  const tdItems= document.createElement("td");
  const tdTot  = document.createElement("td");
  const tdStat = document.createElement("td");
  const tdAct  = document.createElement("td"); tdAct.className="actions";

  tr.append(tdWhen, tdId, tdName, tdPhone, tdSlot, tdItems, tdTot, tdStat, tdAct);

  // boutons actions
  const btnReady = document.createElement("button");
  btnReady.className="btn"; btnReady.textContent="Prête";
  btnReady.onclick = ()=> setStatus(o.id,'ready');

  const btnDone = document.createElement("button");
  btnDone.className="btn primary"; btnDone.textContent="Terminée";
  btnDone.onclick = ()=> setStatus(o.id,'done');

  const btnCancel = document.createElement("button");
  btnCancel.className="btn red"; btnCancel.textContent="Annuler";
  btnCancel.onclick = ()=> setStatus(o.id,'canceled');

  const btnX = document.createElement("button");
  btnX.className="btn"; btnX.textContent="✖";
  btnX.title = "Retirer cette ligne (local)";
  btnX.onclick = ()=> { tr.remove(); rows.delete(o.id); };

  tdAct.append(btnReady, btnDone, btnCancel, btnX);

  // méthode de mise à jour
  tr.update = (data)=>{
    tdWhen.textContent = data.when||"";
    tdId.textContent   = data.id||"";
    tdName.textContent = data.name||"";
    tdPhone.textContent= data.phone||"";
    tdSlot.textContent = data.slot||"";
    tdItems.textContent= pizzasText(data);
    tdTot.textContent  = euro(data.total);
    tdStat.textContent = data.status||"";
  };

  tr.update(o);
  return tr;
}

function upsert(o){
  if(!o || !o.id) return;
  const tbody = document.querySelector("#orders tbody");
  const rec = rows.get(o.id);
  if(rec){
    rec.tr.update(o);
    rec.data = o;
  }else{
    const tr = buildRow(o);
    rows.set(o.id, {tr, data:o});
    tbody.prepend(tr); // nouvelles en haut
    // son de cloche pour nouvelle entrée (pas pour MAJ)
    try{ document.getElementById("ding").play(); }catch{}
  }
}

async function fetchAndMerge(){
  try{
    status.textContent="Chargement…";
    const res = await fetch(api.value + "?t=" + Date.now());
    const data = await res.json();
    if(!data.ok) throw new Error(data.error||"API");
    (data.orders||[]).forEach(upsert);
    status.textContent = "Dernière mise à jour — " + new Date().toLocaleTimeString("fr-FR");
  }catch(e){
    status.textContent="Erreur: "+e.message;
    console.error(e);
  }
}

async function setStatus(id,statusNew){
  try{
    await fetch(api.value, {
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify({ admin: adminkey.value||"", id, status: statusNew })
    });
    // on met aussi à jour la ligne locale
    const rec = rows.get(id);
    if(rec){ rec.data.status = statusNew; rec.tr.update(rec.data); }
  }catch(e){ alert("Erreur: "+e.message); }
}

function demoOrder(){
  const demo = {
    id:"DEMO-"+Math.random().toString(36).slice(2,6).toUpperCase(),
    when: new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),
    name:"Test JSONP", phone:"06 00 00 00 00", slot:"19:00",
    basket:[{name:"Margharita",qty:1}], total:7.50, status:"new"
  };
  upsert(demo);
  status.textContent = "Démo ajoutée";
}

/* 1er chargement + refresh pour écouter les nouvelles commandes,
   sans jamais vider le tableau existant. */
fetchAndMerge();
setInterval(fetchAndMerge, 10000);
</script>
</body>
</html>
