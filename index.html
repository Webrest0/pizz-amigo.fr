<script>
/* ========= CONFIG ========= */
const API_URL = "https://script.google.com/macros/s/AKfycbw6YCxMsuQWvbseL44mpzaTFsaFq2PtzUhyea6M3yEy5dWjUMg7an97Lld9vo4aFIg7/exec";
const ADMIN_KEY = ""; // laisse vide si non utilisÃ©

/* ========= DONNÃ‰ES MENU ========= */
const MENU = [
  {name:"Margharita", price:7.50, desc:"tomate, emmental"},
  {name:"Chasseur", price:8.50, desc:"tomate, emmental, champignons"},
  {name:"Sicilienne", price:8.50, desc:"tomate, emmental, anchois"},
  {name:"Napolitaine", price:9.00, desc:"tomate, emmental, jambon"},
  {name:"Paysanne", price:9.50, desc:"tomate, emmental, jambon, Å“uf"},
  {name:"Capri", price:9.50, desc:"tomate, emmental, jambon, champignons"},
  {name:"Mozzarella", price:9.50, desc:"tomate, emmental, mozzarella"},
  {name:"Quatre saisons", price:9.50, desc:"tomate, emmental, oignons, champignons, poivrons, mozzarella"},
  {name:"Venitienne", price:9.50, desc:"tomate, emmental, roquefort, oignons, crÃ¨me"},
  {name:"Oslo", price:10.00, desc:"tomate, emmental, thon, champignons, crÃ¨me"},
  {name:"Orientale", price:10.00, desc:"tomate, emmental, merguez, poivrons"},
  {name:"Bolognaise", price:10.00, desc:"tomate, emmental, viande hachÃ©e, crÃ¨me, mozzarella"},
  {name:"Fermiere", price:10.00, desc:"tomate, emmental, Å“uf, lardons, champignons"},
  {name:"Miel", price:10.50, desc:"crÃ¨me, emmental, chÃ¨vre frais, miel"},
  {name:"Forestiere", price:10.50, desc:"tomate, emmental, poulet, champignons, crÃ¨me"},
  {name:"Lyonnaise", price:11.00, desc:"tomate, emmental, saint-marcellin, poulet, crÃ¨me"},
  {name:"Quatre fromages", price:11.00, desc:"tomate, emmental, chÃ¨vre, roquefort, mozzarella"},
  {name:"Paradoxe", price:11.00, desc:"tomate, emmental, Å“uf, jambon, chorizo, mozzarella"},
  {name:"Boisee", price:11.00, desc:"crÃ¨me, emmental, pomme de terre, poulet, poivrons, sauce gruyÃ¨re"},
  {name:"Savoyarde", price:11.00, desc:"tomate, emmental, lardons, reblochon, pomme de terre, crÃ¨me"},
  {name:"Carnivore", price:11.50, desc:"tomate, emmental, viande hachÃ©e, merguez, Å“uf, mozzarella"},
  {name:"Norvegienne", price:11.50, desc:"emmental, saumon fumÃ©, mozzarella, crÃ¨me"},
  {name:"Burger", price:12.00, desc:"tomate, emmental, viande hachÃ©e, oignons, cheddar, tomate cerise, sauce burger"},
  {name:"Canette 33cl (choisie sur place)", price:1.50, desc:"boisson â€” saveur choisie sur place"},
  {name:"Bouteille 50cl (choisie sur place)", price:3.00, desc:"boisson â€” saveur choisie sur place"}
];
const SUP_TYPES = ["Viande","Poisson","Å’uf","Fromage"];

/* ========= PANIER ========= */
const cart = {
  items: [], // {name, qty, price}
  get total(){return this.items.reduce((s,i)=>s+i.price*i.qty,0)},
  addLine(label, price){
    const found = this.items.find(x=>x.name===label && x.price===price);
    if(found) found.qty++; else this.items.push({name:label, price, qty:1});
    renderCartBar();
  },
  removeIndex(i){ this.items.splice(i,1); renderCartBar(); },
  clear(){ this.items.length=0; renderCartBar(); }
};
function euros(n){ return n.toFixed(2).replace(".", ","); }

/* ========= RENDU MENU ========= */
function isDrink(p){ return /canette|bouteille|boisson/i.test(p.name+" "+(p.desc||"")); }

function renderMenu(){
  const root = document.getElementById('menu');
  root.innerHTML = "";
  MENU.forEach(p=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div>
        <div class="title">${p.name}</div>
        <div class="desc">${p.desc||""}</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="price">${euros(p.price)} â‚¬</div>
        <button class="btn">Ajouter</button>
      </div>`;
    row.querySelector('.btn').addEventListener('click', async ()=>{
      let label = p.name, price = p.price;

      // SupplÃ©ment seulement si ce n'est PAS une boisson
      if(!isDrink(p)){
        const want = confirm("SupplÃ©ment +1 â‚¬ ?\nOK = Oui Â· Annuler = Non");
        if(want){
          const t = await chooseSupplement();
          if(t){ label += ` (+1 suppl. ${t})`; price += 1; }
        }
      }
      cart.addLine(label, price);
    });
    root.appendChild(row);
  });
}

/* ========= SUPP SÃ‰LECTEUR ========= */
function chooseSupplement(){
  return new Promise(resolve=>{
    const dlg = document.getElementById('supModal');
    const zone = document.getElementById('supChips');
    zone.innerHTML = "";
    let selected = null;
    SUP_TYPES.forEach(t=>{
      const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=t;
      b.onclick=()=>{ [...zone.children].forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); selected=t; };
      zone.appendChild(b);
    });
    document.getElementById('supCancel').onclick = ()=>{ dlg.close(); resolve(null); };
    document.getElementById('supOk').onclick     = ()=>{ dlg.close(); resolve(selected); };
    dlg.showModal();
  });
}

/* ========= BAR PANIER ========= */
function renderCartBar(){
  const bar = document.getElementById('cartbar');
  const tot = document.getElementById('cartTotal');
  if(cart.items.length===0){ bar.classList.add('hidden'); tot.textContent="0,00"; }
  else{ bar.classList.remove('hidden'); tot.textContent = euros(cart.total); }
}

/* ========= MODAL ========= */
function openModal(){
  const list = document.getElementById('ckList'); list.innerHTML="";
  cart.items.forEach((it,idx)=>{
    const row = document.createElement('div'); row.className='ck-row';
    row.innerHTML = `
      <div>${it.name}</div>
      <div class="qty">
        <button class="iconbtn" data-a="minus">âˆ’</button>
        <div style="min-width:28px;text-align:center;line-height:40px">${it.qty}</div>
        <button class="iconbtn" data-a="plus">+</button>
      </div>
      <div class="price">${euros(it.price)} â‚¬</div>
      <button class="iconbtn trash" title="Supprimer" data-a="trash">ðŸ—‘</button>
      <div></div>`;
    row.querySelector('[data-a="minus"]').onclick=()=>{ if(it.qty>1) it.qty--; else cart.removeIndex(idx); openModal(); };
    row.querySelector('[data-a="plus"]').onclick =()=>{ it.qty++; openModal(); };
    row.querySelector('[data-a="trash"]').onclick=()=>{ cart.removeIndex(idx); openModal(); };
    list.appendChild(row);
  });
  document.getElementById('ckTotal').textContent = euros(cart.total);
  document.getElementById('checkout').showModal();
}

function renderSlots(){
  const s=["18:00","18:30","19:00","19:30","20:00","20:30"];
  const zone=document.getElementById('slotChips'); zone.innerHTML="";
  const input=document.getElementById('slot');
  s.forEach(t=>{
    const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=t;
    b.onclick=()=>{ input.value=t; [...zone.children].forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
    if(input.value===t) b.classList.add('sel');
    zone.appendChild(b);
  });
}

/* ========= ENVOI (text/plain pour Ã©viter le preflight CORS) ========= */
async function sendOrder(){
  const name  = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const slot  = document.getElementById('slot').value.trim();
  const note  = document.getElementById('note').value.trim();
  if(!name || !phone || !slot || cart.items.length===0){
    alert("Merci de complÃ©ter nom, tÃ©lÃ©phone, horaire et panier."); return;
  }

  const payload = {
    name, phone, slot, note,
    items: cart.items.map(i=>({name:i.name, qty:i.qty, price:i.price})),
    total: Number(cart.total.toFixed(2)),
    source: "site"
  };
  const url = API_URL + (ADMIN_KEY?`?key=${encodeURIComponent(ADMIN_KEY)}`:"");

  try{
    const res = await fetch(url, {
      method:"POST",
      // IMPORTANT: text/plain -> pas de prÃ©-requÃªte OPTIONS
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    let data; try{ data = JSON.parse(text); }catch{ data={ok:false}; }
    if(!res.ok || data.ok!==true){
      console.error("API error", res.status, text);
      alert("Impossible d'envoyer la commande. Merci de rÃ©essayer.");
      return;
    }
    cart.clear();
    document.getElementById('checkout').close();
    document.getElementById('name').value="";
    document.getElementById('phone').value="";
    document.getElementById('note').value="";
    alert("Commande envoyÃ©e âœ… Merci !");
  }catch(e){
    console.error(e);
    alert("Impossible d'envoyer la commande. Merci de rÃ©essayer.");
  }
}

/* ========= INIT ========= */
document.getElementById('btnView').onclick = openModal;
document.getElementById('btnCheckout').onclick = openModal;
document.getElementById('btnClose').onclick = ()=>document.getElementById('checkout').close();
document.getElementById('btnSend').onclick = sendOrder;

renderMenu(); renderCartBar(); renderSlots();
</script>
